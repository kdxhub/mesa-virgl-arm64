name: Build Mesa-virgl arm64 deb

on:
  schedule:
    - cron: '0 2 1 * *'      # 每月 1 号 02:00 UTC
  push:
    branches: [ main ]

jobs:
  build:
    # 1. 先用 x86_64 官方 runner，交叉编到 arm64
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 2. 装交叉工具链和依赖（头文件库用 arm64 版）
      - name: Install cross toolchain and deps
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            pkg-config-aarch64-linux-gnu \
            meson ninja-build \
            python3 python3-pip python3-mako \
            llvm-dev:arm64 clang lld \
            flex bison byacc cmake \
            libdrm-dev:arm64 libxml2-dev:arm64 libzstd-dev:arm64 \
            libelf-dev:arm64 libx11-dev:arm64 libxext-dev:arm64 \
            libxdamage-dev:arm64 libxcb*-dev:arm64 \
            libunwind-dev:arm64 checkinstall

      # 3. 拉 Mesa
      - name: Clone Mesa
        run: |
          git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git mesa-src

      # 4. 写一份交叉文件
      - name: Create cross file
        run: |
          cat > cross_a64.txt <<'EOF'
          [binaries]
          c       = 'aarch64-linux-gnu-gcc'
          cpp     = 'aarch64-linux-gnu-g++'
          ar      = 'aarch64-linux-gnu-ar'
          strip   = 'aarch64-linux-gnu-strip'
          pkgconfig = 'aarch64-linux-gnu-pkg-config'

          [properties]
          root = '/usr/aarch64-linux-gnu'

          [host_machine]
          system     = 'linux'
          cpu_family = 'aarch64'
          cpu        = 'arm64'
          endian     = 'little'
          EOF

      # 5. 配置 & 编译
      - name: Configure & build
        run: |
          cd mesa-src
          meson setup build \
            --cross-file ../cross_a64.txt \
            -Dprefix=/usr \
            -Dplatforms=x11 \
            -Dgallium-drivers=virgl,swrast \
            -Dvulkan-drivers= \
            -Dllvm=enabled \
            -Dbuildtype=release
          ninja -C build

      # 6. 用 checkinstall 打 deb（会自动写 Architecture: arm64）
      - name: Create .deb package
        run: |
          cd mesa-src
          # 让 checkinstall 用 ninja 安装
          echo "checkinstall -y --pkgname=mesa-virgl-arm64 \
                --pkgversion=\"$(date +%Y%m%d)-${GITHUB_RUN_NUMBER}\" \
                --arch=arm64 \
                --backup=no --deldoc=yes \
                ninja -C build install"
          sudo checkinstall -y --pkgname=mesa-virgl-arm64 \
                --pkgversion="$(date +%Y%m%d)-${GITHUB_RUN_NUMBER}" \
                --arch=arm64 \
                --backup=no --deldoc=yes \
                ninja -C build install
          # 把生成的 deb 拷出来
          mkdir -p ../out
          cp *.deb ../out/

      # 7. 上传 Release
      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          files: out/*.deb
          name: Mesa-virgl arm64 build ${{ github.run_number }}
          body: |
            自动交叉编译 Mesa-virgl（含 virpipe）  
            用法：  
            ```bash
            sudo dpkg -i mesa-virgl-arm64_*.deb
            export GALLIUM_DRIVER=virpipe
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
